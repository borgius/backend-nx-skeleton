import { MongooseModuleOptions } from '@nestjs/mongoose'
import { ConfigService } from '@webundsoehne/nestjs-util'

const { authentication, connectOptions, mockOptions, ...databaseOptions } = ConfigService.get('database')

let mockFlag: boolean = false
function setMockFlag (mock?: any): boolean {
  if (typeof mock !== 'undefined') {
    mockFlag = typeof mock === 'string' ? mock.toLowerCase() === 'true' || Boolean(Number(mock)) : Boolean(mock)
  }

  return mockFlag
}

export function getDatabaseOptions (mock?: boolean): [string, MongooseModuleOptions] {
  const options = setMockFlag(mock) ? { ...databaseOptions, ...mockOptions } : databaseOptions
  const uri = `mongodb://${options.host}${options?.port ? `:${options.port}` : ''}/${options.database}`

  const mongoOptions: MongooseModuleOptions = { ...connectOptions }

  if (authentication?.username && authentication?.password) {
    mongoOptions.user = authentication.username
    mongoOptions.pass = authentication.password
  }

  return [uri, mongoOptions]
}
